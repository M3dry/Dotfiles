#!/usr/bin/env bb

(require '[babashka.process :as p])
(require '[babashka.fs :as fs])

(def where (fs/expand-home "~/my-stuff/Music"))

(def what
     [{:artist "Billie-Eilish"
       :albums [{:album "Happier-Than-Ever"
                 :link  "https://open.spotify.com/album/0JGOiO34nwfUdDrD612dOp?si=0GuMs9cDTRKULYCrkEYghQ"}
                {:album "No-Time-To-Die"
                 :link  "https://open.spotify.com/album/5sXSHscDjBez8VF20cSyad?si=80jPGe3IQSaXG7TrNjjO_A"}
                {:album "When-We-All-Fall-Asleep,-Where-Do-We-Go"
                 :link  "https://open.spotify.com/album/0S0KGZnfBGSIssfF54WSJh?si=FBJfXvbQQDuaxaAkDK3amg"}
                {:album "Lovely"
                 :link  "https://open.spotify.com/album/2sBB17RXTamvj7Ncps15AK?si=0e_yQJRsTtqdC2eQgNLApA"}]}
      {:artist "Taylor-Swift"
       :albums [{:album "Speak-Now"
                 :link  "https://open.spotify.com/album/5AEDGbliTTfjOB8TSm1sxt?si=NDDVj3yrRtePZ9SicOptyQ"}
                {:album "Midnights"
                 :link  "https://open.spotify.com/album/1fnJ7k0bllNfL1kVdNVW1A?si=0DXMvh1hQ-mgsHFK32WaNg"}
                {:album "Red"
                 :link  "https://open.spotify.com/album/6kZ42qRrzov54LcAk4onW9?si=yVwQHhKySmSp7F5ms2EFEw"}
                {:album "Fearless"
                 :link  "https://open.spotify.com/album/4hDok0OAJd57SGIT8xuWJH?si=Nm4p9PyrQJuEdVu2E5RuIQ"}
                {:album "Evermore"
                 :link  "https://open.spotify.com/album/6AORtDjduMM3bupSWzbTSG?si=aQah0GfTRKCt6CFUhVaySA"}
                {:album "Folklore"
                 :link  "https://open.spotify.com/album/2fenSS68JI1h4Fo296JfGr?si=5Qnt_8stQV6tlh1PTd8n5Q"}
                {:album "Lover"
                 :link  "https://open.spotify.com/album/1NAmidJlEaVgA3MpcPFYGq?si=cOJWpaDYQkC0JTw4aVFagA"}
                {:album "Reputation"
                 :link  "https://open.spotify.com/album/6DEjYFkNZh67HP7R9PSZvv?si=qSLhuvL0QOOHw9EWhSoltA"}
                {:album "1989"
                 :link  "https://open.spotify.com/album/1yGbNOtRIgdIiGHOEBaZWf?si=scW0FfjqTfyDzmfHC0vSqw"}]}
      {:artist "Olivia-Rodrigo"
       :albums [{:album "Sour"
                 :link  "https://open.spotify.com/album/6s84u2TUpR3wdUv4NgKA2j?si=gbVIxtaxRLat9qu9mdT_RQ"}]}
      {:artist "Paramore"
       :albums [{:album "This-Is-Why"
                 :link  "https://open.spotify.com/album/6tG8sCK4htJOLjlWwb7gZB?si=pJCaYLs4QvqUAqA8GATdTA"}
                {:album "After-Laughter"
                 :link  "https://open.spotify.com/album/1c9Sx7XdXuMptGyfCB6hHs?si=YMj0O-E7SKChV27Z8XCduA"}
                {:album "Paramore"
                 :link  "https://open.spotify.com/album/7J2hXOVq8FZ367dTczV7oH?si=eUTy2wP2TPKhyWmmm-idug"}
                {:album "Brand-New-Eyes"
                 :link  "https://open.spotify.com/album/3CaQTJU2Cpx7GXTgenmb2r?si=U-CFNc1jR52wg5Hre_a5aA"}
                {:album "The-Final-Riot"
                 :link  "https://open.spotify.com/album/2O5UJpwxMKjhnoe5YVkEcY?si=11Hxssp-RyWz682amNwilA"}
                {:album "Riot"
                 :link  "https://open.spotify.com/album/3UoOO8m0oxxvUHXUKf3qcZ?si=sujQ18jmSt-iNFf5yk3DCg"}
                {:album "All-We-Know-Is-Falling"
                 :link  "https://open.spotify.com/album/67f6SSb8yKduNCK15DsafC?si=3yA2vfJOQEOd773vWHYEQQ"}]}
      {:artist "Dua-Lipa"
       :albums [{:album "Dance-The-Night"
                 :link  "https://open.spotify.com/album/5cH7FqB7JD5q1tJXJ7FHYu?si=yO9nPrCtRruki3Gfv7oXEw"}
                {:album "Potion"
                 :link  "https://open.spotify.com/album/1V6HksALLzO5ihpU3YVqJc?si=VLn50h8kQau_jHXIpKVMWg"}
                {:album "We,re-Good"
                 :link  "https://open.spotify.com/album/4t3Ur7xbLyt0ybULu8jJMH?si=8qYqvMAISYGdauI4UzQATA"}
                {:album "Future-Nostalgia"
                 :link  "https://open.spotify.com/album/0JeyP8r2hBxYIoxXv11XiX?si=C7dSY0j9R9Gak6t-9K4AAQ"}]}
      {:artist "Post-Malone"
       :albums [{:album "Twelve-Carat-Toothache"
                 :link  "https://open.spotify.com/album/50MzJhO0pMjTsfpeOmZ1so?si=G-SZSc62Rzm-Ce1kLUwIXw"}
                {:album "Hollywood,s-Bleeding"
                 :link  "https://open.spotify.com/album/4g1ZRSobMefqF6nelkgibi?si=bZwImRm0QMuaJ2p7lueTeg"}
                {:album "Beerbongs-n-Bentleys"
                 :link  "https://open.spotify.com/album/6trNtQUgC8cgbWcqoMYkOR?si=AZRy27wuRuOJgxQp1OxvHw"}
                {:album "Stoney"
                 :link  "https://open.spotify.com/album/5s0rmjP8XOPhP6HhqOhuyC?si=7V3vuJbTRSu2lR0dgqJWuA"}]}
      {:artist "Sleep-Token"
       :albums [{:album "Take-Me-Back-To-Eden"
                 :link  "https://open.spotify.com/album/1gjugH97doz3HktiEjx2vY?si=hZciV71XRY-qsH2wRQHaIQ"}
                {:album "This-Place-Will-Become-Your-Tomb"
                 :link  "https://open.spotify.com/album/4SD2UxRO9OgeSCQK0PN7cC?si=nmb6Cw7LThmuP9yc_z7tpQ"}
                {:album "Sundowning"
                 :link  "https://open.spotify.com/album/21XQQZZq1cO45mJ2U3vVdp?si=f_taQMcbRtqI7Z79ykiB9A"}]}
      {:artist "Black-Sabbath"
       :albums [{:album "13"
                 :link  "https://open.spotify.com/album/4XQC97RRP7AmyF9mN4lav4?si=qUKQMi-WRoaa8iInKHZkHA"}
                {:album "Never-Say-Die"
                 :link  "https://open.spotify.com/album/35He10lZFJROpQBT16z54R?si=1Dnt1hUvTc6N-AbLtW9dzw"}
                {:album "We-Sold-Our-Soul-For-Rock-n-Roll"
                 :link  "https://open.spotify.com/album/1q9JvqB5Dic8MgFlambgz3?si=hrIhmsiLTjivXuXmOQpVFQ"}]}
      {:artist "System-Of-A-Down"
       :albums [{:album "Hypnotize"
                 :link  "https://open.spotify.com/album/1UeOoLhpWzpuM5cWQsbCXg?si=t4ZxbxPqRj6CWW-XSFfW9A"}
                {:album "Mezmerize"
                 :link  "https://open.spotify.com/album/0cn6MHyx4YuZauaB7Pb66o?si=p0pF5xEoQYOM-M0o8OWBjA"}
                {:album "Steal-This-Album"
                 :link  "https://open.spotify.com/album/6lA1sGw7eCv27bcpd5E0wT?si=S9vRleoEQQGTNsq-vlbX1A"}
                {:album "Toxicity"
                 :link  "https://open.spotify.com/album/6jWde94ln40epKIQCd8XUh?si=fFwyJjGESn-Q8MXgQs59GQ"}
                {:album "System-Of-A-Down"
                 :link  "https://open.spotify.com/album/3sSfjX4fhZonjyZ10x0l0f?si=8W5cxtMJTyS2XAg4MGcvLg"}]}])
      ; {:artist ""
      ;  :albums [{:album ""
      ;            :link  ""}]}])

(defn download [dir link]
  (async/thread (p/shell "docker"
                         "run"
                         "--rm"
                         "-v"
                         (str (fs/expand-home dir) ":/music")
                         "spotdl"
                         "download"
                         link)))

(when-not (fs/exists? where)
          (fs/create-dir where))

(->> what
    (mapcat (fn [{:keys [artist albums]}]
               (let [artist (str where "/" artist)]
                 (when-not (fs/exists? artist)
                           (fs/create-dir artist))
                 (map (fn [{:keys [album link]}]
                        (let [album (str artist "/" album)]
                          (when-not (fs/exists? album)
                                    (fs/create-dir album))
                          (download album link)))
                    albums))))
    (doall)
    (map async/<!!)
    (dorun))
